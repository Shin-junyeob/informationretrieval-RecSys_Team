# ğŸ“˜ ê³¼í•™ ì§€ì‹ ê¸°ë°˜ RAG ì‹œìŠ¤í…œ êµ¬ì¶• í”„ë¡œì íŠ¸

ë³¸ í”„ë¡œì íŠ¸ëŠ” **ê³¼í•™ ì§€ì‹ ì§ˆì˜ì‘ë‹µ(Science QA)** ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ê¸° ìœ„í•´ ì§„í–‰ë˜ì—ˆìœ¼ë©°,  
documents.jsonl ê¸°ë°˜ RAG ê²€ìƒ‰ ë° LLM ê¸°ë°˜ ë‹µë³€ ìƒì„± êµ¬ì¡°ë¥¼ ìµœì í™”í•˜ê¸° ìœ„í•´  
ì´ 4ë‹¨ê³„ì˜ êµ¬ì¡° ê°œì„  ë° ì‹¤í—˜ì„ ìˆ˜í–‰í•˜ì˜€ë‹¤.

---

# ğŸ§ª ì‹¤í—˜ê²°ê³¼ ìš”ì•½

| ë‹¨ê³„ | ì„¤ëª… | MAP | MRR |
|------|------|------|------|
| **Step 1** | Baseline Code | **0.7136** | **0.7167** |
| **Step 2** | ëª¨ë“ˆí™” + ì„ë² ë”© ëª¨ë¸ & Chunking A/B í…ŒìŠ¤íŠ¸ | **0.7705** | **0.7742** |
| **Step 3** | Router + Multi-Query RAG (í˜„ì¬ ìµœê³  ì„±ëŠ¥) | **0.7902** | **0.7924** |
| **Step 4** | Cross-Encoder Reranker ì ìš© (ì²« ì‹œë„) | **0.7000** | **0.7030** |

---

# ğŸŸ¦ Step 1. Baseline Code ì‹¤í–‰ ë° ë¶„ì„

ëŒ€íšŒ ì œê³µ baseline ì½”ë“œëŠ” ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰ëœë‹¤:

- documents.jsonl â†’ ì²­í‚¹(chunking)
- ì„ë² ë”© ìƒì„± â†’ ë²¡í„°ìŠ¤í† ì–´ êµ¬ì¶•
- eval.jsonl ì§ˆì˜ ì²˜ë¦¬
- standalone query ìƒì„±
- top-k retrieval
- LLM ë‹µë³€ ìƒì„±
- submission.jsonl ì €ì¥

### âœ” Step 1 ê²°ê³¼  
- **MAP: 0.7136**  
- **MRR: 0.7167**

### âœ” ë¬¸ì œì   
baselineì€ ë™ì‘ì€ í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ í•œê³„ë¥¼ ê°€ì§„ë‹¤:

1. ëª¨ë“  ë¡œì§ì´ í•˜ë‚˜ì— ë¬¶ì—¬ ìˆì–´ ìœ ì§€ë³´ìˆ˜/í™•ì¥ì´ ì–´ë µë‹¤  
2. ì„ë² ë”©/ì²­í‚¹ ì‹¤í—˜ ë“± ë‹¤ì–‘í•œ A/B í…ŒìŠ¤íŠ¸ê°€ ë¶ˆê°€ëŠ¥  
3. retrieval-only ì„±ëŠ¥ì„ ë…ë¦½ì ìœ¼ë¡œ í‰ê°€í•  ìˆ˜ ì—†ìŒ  
4. êµ¬ì¡°ê°€ ë³µì¡í•´ RAG ê°œì„  ì‹¤í—˜ì„ ì ìš©í•˜ê¸° ì–´ë µë‹¤  

â¡ Step 2ì—ì„œëŠ” ì „ì²´ ì½”ë“œë¥¼ ëª¨ë“ˆí˜• êµ¬ì¡°ë¡œ ì¬ì„¤ê³„í•˜ì˜€ë‹¤.

---

# ğŸŸ© Step 2. ëª¨ë“ˆí™” + Embedding Ã— Chunking A/B í…ŒìŠ¤íŠ¸

### âœ” 1) ì „ì²´ ì½”ë“œ ëª¨ë“ˆí™”  
ì½”ë“œë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ì™„ì „íˆ ë¶„ë¦¬í•˜ì—¬ í™•ì¥ì„±ê³¼ ì‹¤í—˜ ë°˜ë³µì„±ì„ í™•ë³´:

- embedder.py  
- chunker.py  
- vector_store.py  
- llm.py  
- eval_runner.py  

---

### âœ” 2) ì„ë² ë”© ëª¨ë¸ ì‹¤í—˜  
ë‘ ê°œì˜ multilingual embedding ëª¨ë¸ì„ í…ŒìŠ¤íŠ¸:

- **BAAI/bge-m3**  
- **intfloat/multilingual-e5-large**

---

### âœ” 3) Chunking ì „ëµ ì‹¤í—˜  
ì´ 3ê°œì˜ ì „ëµì„ ì„¤ê³„í•´ embedding Ã— chunking ì¡°í•©ì„ A/B í…ŒìŠ¤íŠ¸:

- **A:** Fixed-length + Overlap  
- **B:** Section-aware Chunking (ë¬¸ë‹¨ ê¸°ë°˜)  
- **C:** Equation-aware Chunking (ìˆ˜ì‹ ê¸°ë°˜ ë¶„ë¦¬)  

---

### âœ” 4) Retrieval-only í‰ê°€ ì½”ë“œ êµ¬í˜„  
LLM í˜¸ì¶œ ì—†ì´ embedding/chunking íš¨ê³¼ë¥¼ ë¹„êµí•˜ê¸° ìœ„í•´  
pseudo-retrieval benchmark ìì²´ êµ¬í˜„.

---

### âœ” Step 2 ê²°ê³¼  
- **MAP: 0.7705**  
- **MRR: 0.7742**

â¡ Step 1 ëŒ€ë¹„ ì•½ **+0.06** ìƒìŠ¹  
â¡ í•˜ì§€ë§Œ embedding/ì²­í‚¹ ê¸°ë°˜ ê°œì„ ë§Œìœ¼ë¡œëŠ” í•œê³„ ì¡´ì¬

---

# ğŸŸ¨ Step 3. Router + Multi-Query RAG (í˜„ì¬ ê°€ì¥ ë†’ì€ ì„±ëŠ¥)

ì´ ë‹¨ê³„ê°€ ëª¨ë“  ì‹¤í—˜ ì¤‘ **ìµœê³  ì„±ëŠ¥(0.79)** ì„ ê¸°ë¡í•˜ì˜€ë‹¤.

---

## âœ” 1) Router ìƒì„± (ê³¼í•™ ì§ˆì˜ / ì¼ë°˜ ëŒ€í™” ë¶„ë¦¬)

eval.jsonlì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ **ì¼ìƒ ëŒ€í™”(non-science) ì§ˆì˜**ê°€ ì¡´ì¬:

- â€œìš”ìƒˆ ë„ˆë¬´ í˜ë“¤ì–´â€
- â€œë‹ˆê°€ ì˜í•´ì„œ ê¸°ë¶„ ì¢‹ë‹¤â€
- â€œìë‹ˆ?â€

ì´ëŸ° ì§ˆì˜ê¹Œì§€ RAG retrievalì„ ê±°ì¹˜ë©´ ì˜¤íˆë ¤ scoreê°€ í•˜ë½í•œë‹¤.

â¡ ë”°ë¼ì„œ lightweight Router ë„ì…:

- **GENERAL** â†’ RAG ìƒëµ, LLM ë°”ë¡œ ë‹µë³€  
- **SCIENCE** â†’ RAG ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰  

â†’ Retrieval noise ì œê±° â†’ MAP/MRR ìƒìŠ¹ íš¨ê³¼

---

## âœ” 2) Standalone Query Rewriting  
ì§ˆë¬¸ì„ self-contained ì§ˆì˜ë¡œ ì¬ì‘ì„±í•˜ì—¬ retrieval ì •í™•ë„ ê°•í™”.

---

## âœ” 3) Multi-Query Paraphrasing  
LLMì„ í†µí•´ í•˜ë‚˜ì˜ ì§ˆë¬¸ì„ ë‹¤ì–‘í•œ í‘œí˜„ìœ¼ë¡œ í™•ì¥:

- paraphrase ìƒì„±  
- ê° ì§ˆë¬¸ìœ¼ë¡œ retrieval  
- í›„ë³´êµ° union  
- recall ê·¹ëŒ€í™”

â†’ retrieverê°€ ë†“ì¹˜ëŠ” ë¬¸ì„œ ê°ì†Œ  
â†’ ìµœì¢… top-k ë‚´ ì •ë‹µ í¬í•¨ í™•ë¥ ì´ í¬ê²Œ ì¦ê°€  

---

### âœ” Step 3 ê²°ê³¼ (í˜„ì¬ ìµœê³  ì„±ëŠ¥ ë‹¨ê³„)  
- **MAP: 0.7902**  
- **MRR: 0.7924**

â¡ Step 2 ëŒ€ë¹„ ì¶”ê°€ ìƒìŠ¹  
â¡ í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ ê°€ì¥ ë†’ì€ ì„±ëŠ¥ ê¸°ë¡

---

# ğŸŸ¥ Step 4. Cross-Encoder Reranker ì ìš© (ì²« ì‹œë„)

retriever ê²°ê³¼ë¥¼ ì˜ë¯¸ ê¸°ë°˜ìœ¼ë¡œ ì¬ì •ë ¬í•˜ê¸° ìœ„í•´  
Cross-Encoder ê¸°ë°˜ reranker(**BAAI/bge-reranker-large**)ë¥¼ ì ìš©í•˜ì˜€ë‹¤.

### Rerank êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤:

retriever_topk = 20
â†’ reranker_topk = 5
â†’ LLM ë‹µë³€ ìƒì„±


### âœ” Step 4 ê²°ê³¼  
- **MAP: 0.7000**  
- **MRR: 0.7030**

â¡ Step 3 ëŒ€ë¹„ ì„±ëŠ¥ í•˜ë½

### âœ” ì ì¬ì  ì›ì¸  
- rerankerì™€ multi-query ê°„ ì‹œë„ˆì§€ ë¶€ì¡±  
- dense-score + rerank-score fusion ë¯¸ì ìš©  
- reranker topk ì„¤ì • ë¹„ìµœì   
- ì¼ë¶€ queryì—ì„œ surface similarity ê³¼ì¶”ì •  
- context drift ë°œìƒ  

â¡ reranker ë‹¨ê³„ëŠ” **ì•ìœ¼ë¡œ íŠœë‹ ì—¬ì§€ê°€ ë§¤ìš° ë§ìŒ**

---

# ğŸ“Š ë‹¨ê³„ë³„ ì„±ëŠ¥ ë¹„êµ ìš”ì•½

| ë‹¨ê³„ | ë‚´ìš© | MAP | MRR |
|------|------|------|------|
| Step 1 | Baseline | 0.7136 | 0.7167 |
| Step 2 | ëª¨ë“ˆí™” + Embedding/Chunking ì‹¤í—˜ | 0.7705 | 0.7742 |
| **Step 3** | **Router + Multi-Query (ìµœê³  ì„±ëŠ¥)** | **0.7902** | **0.7924** |
| Step 4 | Cross-Encoder Reranker | 0.7000 | 0.7030 |

---

# ğŸ“Œ ê²°ë¡ 

í˜„ì¬ê¹Œì§€ **ê°€ì¥ ë†’ì€ ì„±ëŠ¥ì„ ë‹¬ì„±í•œ ë‹¨ê³„ëŠ” Step 3 (Router + Multi-Query RAG)** ì´ë‹¤.  
Step 4ì—ì„œ ì‹œë„í•œ Cross-Encoder RerankerëŠ” ì´ˆê¸° ê²°ê³¼ê°€ ë‚®ê²Œ ë‚˜ì™”ìœ¼ë©°,  
topk ì¡°ì •, score fusion, multi-query weighting ë“± ë‹¤ì–‘í•œ íŠœë‹ì´ í•„ìš”í•˜ë‹¤.

í–¥í›„ ê°œì„ ì„ í†µí•´ reranker ë‹¨ê³„ ì—­ì‹œ ì¶©ë¶„íˆ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ê°€ëŠ¥ì„±ì´ ìˆë‹¤.

